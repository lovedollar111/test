package cn.dogplanet.ui.order;import android.Manifest;import android.content.Context;import android.content.Intent;import android.content.pm.PackageManager;import android.os.Build;import android.os.Bundle;import android.os.Handler;import android.os.Message;import android.support.annotation.NonNull;import android.support.v4.app.ActivityCompat;import android.support.v4.content.ContextCompat;import android.text.Editable;import android.text.TextWatcher;import android.view.View;import android.view.View.OnClickListener;import android.view.WindowManager;import android.view.inputmethod.InputMethodManager;import android.widget.AdapterView;import android.widget.ImageView;import android.widget.ListView;import android.widget.RelativeLayout;import android.widget.TextView;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import butterknife.BindView;import butterknife.ButterKnife;import butterknife.OnClick;import cn.dogplanet.GlobalContext;import cn.dogplanet.R;import cn.dogplanet.app.util.GsonHelper;import cn.dogplanet.app.util.KeyBoardUtils;import cn.dogplanet.app.util.PullToRefreshHelper;import cn.dogplanet.app.util.StringUtils;import cn.dogplanet.app.util.ToastUtil;import cn.dogplanet.app.widget.EditTextWithDel;import cn.dogplanet.app.widget.library.PullToRefreshBase;import cn.dogplanet.app.widget.library.PullToRefreshListView;import cn.dogplanet.baiduApi.AutoCheck;import cn.dogplanet.baiduApi.IRecogListener;import cn.dogplanet.baiduApi.MessageStatusRecogListener;import cn.dogplanet.baiduApi.MyRecognizer;import cn.dogplanet.base.BaseFragmentActivity;import cn.dogplanet.constant.HttpUrl;import cn.dogplanet.constant.WCache;import cn.dogplanet.entity.Expert;import cn.dogplanet.entity.Order;import cn.dogplanet.entity.OrderResp;import cn.dogplanet.net.PublicReq;import cn.dogplanet.net.volley.Response;import cn.dogplanet.net.volley.VolleyError;import cn.dogplanet.ui.order.adapter.OrderAdapter;/** * 订单查询 * editor:ztr * package_name:cn.dogplanet.ui.order * file_name:OrderFindActivity.java * date:2016-12-6 */public class OrderFindActivity extends BaseFragmentActivity {    @BindView(R.id.et_search)    EditTextWithDel etSearch;    @BindView(R.id.img_input)    ImageView imgInput;    @BindView(R.id.list)    PullToRefreshListView list;    @BindView(R.id.tv_tip)    TextView tvTip;    private OrderAdapter adapter;    private Expert expert;    private int current_page = 1;    private Boolean isFirst = true;    private MyRecognizer myRecognizer;    private boolean flag=false;//判断是不是语音输入    public static Intent newIntent() {        return new Intent(GlobalContext.getInstance(),                OrderFindActivity.class);    }    @Override    protected void onCreate(Bundle savedInstanceState) {        // TODO Auto-generated method stub        super.onCreate(savedInstanceState);        setContentView(R.layout.order_find);        ButterKnife.bind(this);        expert = WCache.getCacheExpert();        IRecogListener listener = new MessageStatusRecogListener(new Handler(){            @Override            public void handleMessage(Message msg) {                super.handleMessage(msg);                handleMsg(msg);            }        });        // DEMO集成步骤 1.2 初始化：new一个IRecogListener示例 & new 一个 MyRecognizer 示例        myRecognizer = new MyRecognizer(this, listener);    }    protected void handleMsg(Message msg) {        if (etSearch != null && msg.obj != null && msg.arg2==1) {            if(!"错误码".contains((CharSequence) msg.obj)){                etSearch.setText(msg.obj.toString());                getOrder(HttpUrl.SEARCH_ORDER, etSearch.getText().toString(), 1);                flag=false;            }            stop();        }        initView();    }    private void initView() {        etSearch.addTextChangedListener(new TextWatcher() {            @Override            public void beforeTextChanged(CharSequence s, int start, int count, int after) {            }            @Override            public void onTextChanged(CharSequence s, int start, int before, int count) {            }            @Override            public void afterTextChanged(Editable s) {                if(flag){                    return;                }                if(StringUtils.isNotBlank(s.toString())){                    getOrder(HttpUrl.SEARCH_ORDER, etSearch.getText().toString(), 1);                }            }        });        list.setMode(PullToRefreshBase.Mode.BOTH);        PullToRefreshHelper.initIndicator(list);        PullToRefreshHelper.initIndicatorStart(list);        list.setOnRefreshListener(new PullToRefreshBase.OnRefreshListener2<ListView>() {            @Override            public void onPullDownToRefresh(                    PullToRefreshBase<ListView> refreshView) {                // TODO Auto-generated method stub                refershData();            }            @Override            public void onPullUpToRefresh(                    PullToRefreshBase<ListView> refreshView) {                // TODO Auto-generated method stub                current_page++;                getOrder(HttpUrl.SEARCH_ORDER, etSearch.getText()                        .toString(), 2);            }        });        list.setOnItemClickListener((parent, view, position, id) -> {            Order order = (Order) parent.getAdapter().getItem(position);            startActivity(OrderDetailActivity.newIntent(order.getId()));        });    }    @Override    protected void onResume() {        // TODO Auto-generated method stub        super.onResume();        if (isFirst) {            getWindow().setSoftInputMode(                    WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE);            isFirst = false;        } else {            getWindow().setSoftInputMode(                    WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);        }    }    public void refershData() {        if (null != adapter && null != adapter.getOrders()) {            adapter.getOrders().clear();            adapter.notifyDataSetChanged();        }        current_page = 1;        getOrder(HttpUrl.SEARCH_ORDER, etSearch.getText().toString(), 1);    }    private void getOrder(final String url, String s, final int type) {        if (null != expert) {            Map<String, String> params = new HashMap<>();            params.put("expert_id", expert.getId().toString());            params.put("access_token", expert.getAccess_token());            params.put("keyword", s);            params.put("page_id", String.valueOf(current_page));            PublicReq.request(url, response -> {                list.onRefreshComplete();                InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);                if (imm != null) {                    imm.hideSoftInputFromWindow(etSearch.getWindowToken(), 0);                }                OrderResp respData = GsonHelper.parseObject(response,                        OrderResp.class);                if (null != respData) {                    if (respData.isSuccess()) {                        if (type == 1 && adapter != null) {                            adapter.getOrders().clear();                            adapter.notifyDataSetChanged();                        }                        notifyAdapter(respData.getOrder());                    } else {                        ToastUtil.showError(respData.getMsg());                    }                } else {                    ToastUtil.showError(R.string.network_data_error);                }            }, error -> {                list.onRefreshComplete();                getWindow()                        .setSoftInputMode(                                WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);                ToastUtil.showError(R.string.network_error);            }, params);        }    }    private void notifyAdapter(List<Order> orders) {        if (orders == null || orders.size() == 0) {            tvTip.setVisibility(View.VISIBLE);            list.setVisibility(View.GONE);        } else {            tvTip.setVisibility(View.GONE);            list.setVisibility(View.VISIBLE);        }        if (null == adapter) {            adapter = new OrderAdapter(getApplicationContext(), orders, OrderAdapter.TYPE_FIND, id -> {            });            list.setAdapter(adapter);            adapter.notifyDataSetChanged();        } else {            if (orders != null) {                adapter.getOrders().addAll(orders);            }            adapter.notifyDataSetChanged();        }    }    @OnClick({R.id.btn_cancel, R.id.img_input})    public void onViewClicked(View view) {        switch (view.getId()) {            case R.id.btn_cancel:                finish();                break;            case R.id.img_input:                if (Build.VERSION.SDK_INT >= 23) {                    initPermission();                } else {                    start();                }                KeyBoardUtils.closeKeybord(etSearch,this);                break;        }    }    protected void start() {        flag=true;        // DEMO集成步骤2.1 拼接识别参数： 此处params可以打印出来，直接写到你的代码里去，最终的json一致即可。        final Map<String, Object> params = new HashMap<>();        // params 也可以根据文档此处手动修改，参数会以json的格式在界面和logcat日志中打印        // 复制此段可以自动检测常规错误        (new AutoCheck(getApplicationContext(), new Handler() {            public void handleMessage(Message msg) {                if (msg.what == 100) {                    AutoCheck autoCheck = (AutoCheck) msg.obj;                    synchronized (autoCheck) {                        String message = autoCheck.obtainErrorMessage(); // autoCheck.obtainAllMessage();                        ToastUtil.showError(message);                    }                }            }        }, false)).checkAsr(params);        // 这里打印出params， 填写至您自己的app中，直接调用下面这行代码即可。        // DEMO集成步骤2.2 开始识别        myRecognizer.start(params);    }    /**     * 开始录音后，手动点击“停止”按钮。     * SDK会识别不会再识别停止后的录音。     */    protected void stop() {        // DEMO集成步骤4 (可选） 停止录音        myRecognizer.stop();    }    /**     * 开始录音后，手动点击“取消”按钮。     * SDK会取消本次识别，回到原始状态。     */    protected void cancel() {        // DEMO集成步骤5 (可选） 取消本次识别        myRecognizer.cancel();    }    private void initPermission() {        String permissions[] = {Manifest.permission.RECORD_AUDIO,                Manifest.permission.ACCESS_NETWORK_STATE,                Manifest.permission.INTERNET,                Manifest.permission.READ_PHONE_STATE,                Manifest.permission.WRITE_EXTERNAL_STORAGE        };        ArrayList<String> toApplyList = new ArrayList<>();        for (String perm :permissions){            if (PackageManager.PERMISSION_GRANTED != ContextCompat.checkSelfPermission(this, perm)) {                toApplyList.add(perm);                //进入到这里代表没有权限.            }        }        String tmpList[] = new String[toApplyList.size()];        if (!toApplyList.isEmpty()){            ActivityCompat.requestPermissions(this, toApplyList.toArray(tmpList), 123);        }else{            start();        }    }    @Override    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults){        if (grantResults.length > 0                && grantResults[0] == PackageManager.PERMISSION_GRANTED) {            // 权限被用户同意，可以去放肆了。            start();        } else {            ToastUtil.showError("请开启语音输入权限。");        }    }    @Override    protected void onDestroy() {        // DEMO集成步骤3 释放资源        // 如果之前调用过myRecognizer.loadOfflineEngine()， release()里会自动调用释放离线资源        myRecognizer.release();        super.onDestroy();    }}